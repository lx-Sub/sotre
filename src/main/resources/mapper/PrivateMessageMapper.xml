<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.rabbiter.hrm.mapper.PrivateMessageMapper">

    <resultMap id="BaseResultMap" type="com.rabbiter.hrm.entity.PrivateMessage">
        <id column="id" property="id"/>
        <result column="sender_id" property="senderId"/>
        <result column="receiver_id" property="receiverId"/>
        <result column="content" property="content"/>
        <result column="is_read" property="isRead"/>
        <result column="read_time" property="readTime"/>
        <result column="create_time" property="createTime"/>
    </resultMap>

    <sql id="Base_Column_List">
        id, sender_id, receiver_id, content, is_read, read_time, create_time
    </sql>

    <!-- 根据ID查询 -->
    <select id="selectById" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM private_message
        WHERE id = #{id}
    </select>

    <!-- 根据发送者ID查询 -->
    <select id="selectBySenderId" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM private_message
        WHERE sender_id = #{senderId}
        ORDER BY create_time DESC
    </select>

    <!-- 根据接收者ID查询 -->
    <select id="selectByReceiverId" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM private_message
        WHERE receiver_id = #{receiverId}
        ORDER BY create_time DESC
    </select>

    <!-- 根据条件查询 -->
    <select id="selectByCondition" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM private_message
        <where>
            <if test="senderId != null">
                AND sender_id = #{senderId}
            </if>
            <if test="receiverId != null">
                AND receiver_id = #{receiverId}
            </if>
            <if test="isRead != null">
                AND is_read = #{isRead}
            </if>
            <if test="startDate != null">
                AND create_time >= #{startDate}
            </if>
            <if test="endDate != null">
                AND create_time &lt;= #{endDate}
            </if>
        </where>
        ORDER BY create_time DESC
    </select>

    <!-- 查询两个用户间的私信 -->
    <select id="selectConversation" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM private_message
        WHERE (sender_id = #{userId1} AND receiver_id = #{userId2})
        OR (sender_id = #{userId2} AND receiver_id = #{userId1})
        ORDER BY create_time DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
        <if test="offset != null and limit != null">
            LIMIT #{offset}, #{limit}
        </if>
    </select>

    <!-- 获取最近的私信列表（按用户分组） -->
    <select id="selectRecentConversations" resultType="java.util.Map">
        SELECT
            CASE
                WHEN sender_id = #{userId} THEN receiver_id
                ELSE sender_id
            END as other_user_id,
            MAX(create_time) as last_message_time,
            (SELECT content FROM private_message pm2
             WHERE (pm2.sender_id = sender_id AND pm2.receiver_id = receiver_id)
                OR (pm2.sender_id = receiver_id AND pm2.receiver_id = sender_id)
             ORDER BY create_time DESC LIMIT 1) as last_content,
            SUM(CASE WHEN receiver_id = #{userId} AND is_read = 0 THEN 1 ELSE 0 END) as unread_count
        FROM private_message
        WHERE sender_id = #{userId} OR receiver_id = #{userId}
        GROUP BY other_user_id
        ORDER BY last_message_time DESC
    </select>

    <!-- 插入 -->
    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO private_message (
            sender_id, receiver_id, content, is_read, create_time
        ) VALUES (
            #{senderId}, #{receiverId}, #{content}, #{isRead}, NOW()
        )
    </insert>

    <!-- 更新阅读状态 -->
    <update id="updateReadStatus">
        UPDATE private_message
        SET is_read = #{isRead},
            read_time = #{readTime}
        WHERE id = #{id}
    </update>

    <!-- 批量更新已读状态 -->
    <update id="batchUpdateReadStatus">
        UPDATE private_message
        SET is_read = 1,
            read_time = NOW()
        WHERE receiver_id = #{userId}
          AND sender_id = #{senderId}
          AND is_read = 0
    </update>

    <!-- 统计未读私信数 -->
    <select id="countUnread" resultType="int">
        SELECT COUNT(*)
        FROM private_message
        WHERE receiver_id = #{userId} AND is_read = 0
    </select>

    <!-- 统计与某个用户的未读私信数 -->
    <select id="countUnreadWithUser" resultType="int">
        SELECT COUNT(*)
        FROM private_message
        WHERE receiver_id = #{userId}
          AND sender_id = #{otherUserId}
          AND is_read = 0
    </select>

    <!-- 统计私信总数 -->
    <select id="countByCondition" resultType="int">
        SELECT COUNT(*) FROM private_message
        <where>
            <if test="senderId != null">
                AND sender_id = #{senderId}
            </if>
            <if test="receiverId != null">
                AND receiver_id = #{receiverId}
            </if>
            <if test="startDate != null">
                AND create_time >= #{startDate}
            </if>
            <if test="endDate != null">
                AND create_time &lt;= #{endDate}
            </if>
        </where>
    </select>

    <!-- 删除 -->
    <delete id="deleteById">
        DELETE FROM private_message WHERE id = #{id}
    </delete>

    <!-- 删除与某用户的会话 -->
    <delete id="deleteConversation">
        DELETE FROM private_message
        WHERE (sender_id = #{userId1} AND receiver_id = #{userId2})
           OR (sender_id = #{userId2} AND receiver_id = #{userId1})
    </delete>

</mapper>