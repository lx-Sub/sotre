<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.rabbiter.hrm.mapper.ReviewMapper">

    <resultMap id="BaseResultMap" type="com.rabbiter.hrm.entity.Review">
        <id column="id" property="id"/>
        <result column="order_id" property="orderId"/>
        <result column="user_id" property="userId"/>
        <result column="product_id" property="productId"/>
        <result column="match_score" property="matchScore"/>
        <result column="communication_score" property="communicationScore"/>
        <result column="shipping_score" property="shippingScore"/>
        <result column="overall_score" property="overallScore"/>
        <result column="content" property="content"/>
        <result column="images" property="images"/>
        <result column="reply_content" property="replyContent"/>
        <result column="reply_time" property="replyTime"/>
        <result column="create_time" property="createTime"/>
    </resultMap>

    <sql id="Base_Column_List">
        id, order_id, user_id, product_id, match_score, communication_score,
        shipping_score, overall_score, content, images, reply_content,
        reply_time, create_time
    </sql>

    <select id="selectById" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM review
        WHERE id = #{id}
    </select>

    <select id="selectByOrderId" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM review
        WHERE order_id = #{orderId}
    </select>

    <select id="selectByMerchantId" resultMap="BaseResultMap">
        SELECT r.*, o.product_name, o.product_image, u.username, u.avatar, u.credit_score
        FROM review r
        INNER JOIN `order` o ON r.order_id = o.id
        LEFT JOIN user u ON r.user_id = u.id
        WHERE o.seller_id = #{merchantId}
        ORDER BY r.create_time DESC
    </select>

    <select id="selectByProductId" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM review
        WHERE product_id = #{productId}
        ORDER BY create_time DESC
    </select>

    <select id="getRatingStatsByMerchantId" resultType="java.util.Map">
        SELECT
            COALESCE(AVG(r.overall_score), 0) as avg_overall,
            COALESCE(AVG(r.match_score), 0) as avg_match,
            COALESCE(AVG(r.communication_score), 0) as avg_communication,
            COALESCE(AVG(r.shipping_score), 0) as avg_shipping,
            COUNT(*) as total_count,
            SUM(CASE WHEN r.overall_score >= 4 THEN 1 ELSE 0 END) as good_count,
            SUM(CASE WHEN r.overall_score = 3 THEN 1 ELSE 0 END) as medium_count,
            SUM(CASE WHEN r.overall_score &lt;= 2 THEN 1 ELSE 0 END) as bad_count
        FROM review r
        INNER JOIN `order` o ON r.order_id = o.id
        WHERE o.seller_id = #{merchantId}
    </select>

    <select id="getScoreDistributionByMerchantId" resultType="java.util.Map">
        SELECT
            overall_score as score,
            COUNT(*) as count
        FROM review r
        INNER JOIN `order` o ON r.order_id = o.id
        WHERE o.seller_id = #{merchantId}
        GROUP BY overall_score
        ORDER BY overall_score DESC
    </select>

    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO review (
            order_id, user_id, product_id, match_score, communication_score,
            shipping_score, overall_score, content, images, create_time
        ) VALUES (
            #{orderId}, #{userId}, #{productId}, #{matchScore}, #{communicationScore},
            #{shippingScore}, #{overallScore}, #{content}, #{images}, NOW()
        )
    </insert>

    <update id="updateById">
        UPDATE review
        <set>
            <if test="replyContent != null">reply_content = #{replyContent},</if>
            <if test="replyTime != null">reply_time = #{replyTime},</if>
        </set>
        WHERE id = #{id}
    </update>

</mapper>